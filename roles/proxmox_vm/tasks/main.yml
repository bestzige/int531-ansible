- name: Check Proxmox API connectivity
  ansible.builtin.ping:
  changed_when: false

- name: Get VM info from Proxmox
  community.proxmox.proxmox_vm_info:
    api_host: '{{ proxmox_api_host }}'
    api_user: '{{ proxmox_api_user }}'
    api_password: '{{ proxmox_api_password }}'
    node: '{{ proxmox_node }}'
  register: proxmox_vms
  changed_when: false

- name: Build VM name -> VMID lookup
  ansible.builtin.set_fact:
    proxmox_vm_lookup: >-
      {{ proxmox_vms.proxmox_vms
         | items2dict(key_name='name', value_name='vmid') }}

- name: Resolve template VMID
  ansible.builtin.set_fact:
    template_vmid: >-
      {{ (
           proxmox_vms.proxmox_vms
           | selectattr('name', 'equalto', vm_template)
           | selectattr('template', 'equalto', true)
           | first
         ).vmid }}
  failed_when: template_vmid is not defined

- name: Clone missing VMs from template
  community.proxmox.proxmox_kvm:
    api_host: '{{ proxmox_api_host }}'
    api_user: '{{ proxmox_api_user }}'
    api_password: '{{ proxmox_api_password }}'
    node: '{{ proxmox_node }}'

    clone: '{{ vm_template }}'
    newid: '{{ hostvars[item].vmid }}'
    name: '{{ hostvars[item].vm_name }}'

    ciuser: '{{ vm_user }}'
    cipassword: '{{ vm_password }}'
    sshkeys: "{{ lookup('file', vm_ssh_pubkey) }}"

    ipconfig:
      ipconfig0: 'ip={{ hostvars[item].ansible_host }}/{{ vm_netmask }},gw={{ vm_gateway }}'

    state: present
    timeout: 900
  loop: "{{ groups['vms'] }}"
  when: item not in proxmox_vm_lookup
  register: clone_results

- name: Update existing VMs
  community.proxmox.proxmox_kvm:
    api_host: '{{ proxmox_api_host }}'
    api_user: '{{ proxmox_api_user }}'
    api_password: '{{ proxmox_api_password }}'
    node: '{{ proxmox_node }}'

    vmid: '{{ hostvars[item].vmid }}'
    name: '{{ hostvars[item].vm_name }}'

    ciuser: '{{ vm_user }}'
    cipassword: '{{ vm_password }}'
    sshkeys: "{{ lookup('file', vm_ssh_pubkey) }}"

    ipconfig:
      ipconfig0: 'ip={{ hostvars[item].ansible_host }}/{{ vm_netmask }},gw={{ vm_gateway }}'

    update: true
    state: present
    timeout: 900
  loop: "{{ groups['vms'] }}"
  register: update_results

- name: Stop updated VMs
  community.proxmox.proxmox_kvm:
    api_host: '{{ proxmox_api_host }}'
    api_user: '{{ proxmox_api_user }}'
    api_password: '{{ proxmox_api_password }}'
    node: '{{ proxmox_node }}'
    vmid: '{{ hostvars[item.item].vmid }}'
    state: stopped
  loop: '{{ update_results.results }}'
  when: item.changed

- name: Start updated VMs
  community.proxmox.proxmox_kvm:
    api_host: '{{ proxmox_api_host }}'
    api_user: '{{ proxmox_api_user }}'
    api_password: '{{ proxmox_api_password }}'
    node: '{{ proxmox_node }}'
    vmid: '{{ hostvars[item.item].vmid }}'
    state: started
  loop: '{{ update_results.results }}'
  when: item.changed

- name: Wait for SSH
  ansible.builtin.wait_for:
    host: '{{ hostvars[item].ansible_host }}'
    port: 22
    timeout: 600
  loop: "{{ groups['vms'] }}"
  delegate_to: localhost

- name: Add provisioned VMs to runtime inventory
  ansible.builtin.add_host:
    name: '{{ item }}'
    groups: provisioned_vms
    ansible_host: '{{ hostvars[item].ansible_host }}'
    ansible_user: '{{ vm_user }}'
    ansible_ssh_private_key_file: '{{ vm_ssh_private_key }}'
  loop: "{{ groups['vms'] }}"
