- name: Ensure Prometheus target directory exists
  ansible.builtin.file:
    path: /opt/monitoring/prometheus/targets
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate node_exporter targets
  ansible.builtin.copy:
    dest: /opt/monitoring/prometheus/targets/node_exporter.json
    owner: root
    group: root
    mode: '0644'
    content: |
      [
      {% for host in groups['provisioned_vms'] %}
        {
          "targets": ["{{ hostvars[host].ansible_host }}:9100"],
          "labels": {
            "instance": "{{ host }}",
            "job": "node"
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
      ]
  notify: reload prometheus
